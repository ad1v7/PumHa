PumHa package simulates the population dynamics of hares and pumas in a user-specified landscape. The population densities depend on a number of parameters, such as birth, death and diffusion rates, and also on the rate at which pumas eat hares. For more in-depth mathematical formulation, see PumaPopulation and HarePopulation classes in the pumha.pop module.

PumHa is written in Python programming language, it is compatible with any version of Python 2.7 or higher. Provided the package is correctly installed (see `How to install`_), it can be run in variety of operating systems (see `System compatibility and requirements`_ for a list of operating systems in which the package has been tested). 

The package was developed using `GitHub`_ revision control mechanism and the tests were created using Python's `unittest`_ framework. The code complies with `PEP 257`_ and `PEP 8`_ conventions. The documentation was generated using Sphinx and it is located in the ``docs`` folder inside the project directory.

.. _PEP 257: https://www.python.org/dev/peps/pep-0257/ 
.. _PEP 8: https://www.python.org/dev/peps/pep-0008/
.. _GitHub: https://github.com/
.. _unittest: https://docs.python.org/2/library/unittest.html
.. _nose: https://pypi.python.org/pypi/nose/1.3.7



How to install
==============
To install PumHa package on a Linux machine (see `System compatibility and requirements`_ for known compatibility):

1. Change directory to your install directory (or create one).
2. Copy repository from Github by running the command::

    git clone https://github.com/ad1v7/PumHa

Alternatively, if you are lucky enough to have a tar.gz package in your computer (in fact you would be very lucky because only 4 people out of 7+ billions have it!), you can do the following:

3. Or extract archive content using::
    
     tar zxvf pumha.tar.gz      
        
where pumha.tar.gz is replaced with your archive name.

4. Make sure you are in a directory which contains setup.py and use `pip <http://pip-installer.org>`_::

    pip install .
    
You might need to run the above command as super user (root)::

    sudo pip install .
    
If you can't run it as a root, you can try::

    pip install --user .
    
In that case pip will install command line script into::

    ~/.local/bin
    
directory. This is the case for Scientific Linux and Ubuntu.


If ``~/.local/bin`` is not in your ``$PATH`` (run ``echo $PATH`` to check it), you can export it running::

    export PATH=$PATH:~/.local/bin
    
You may want to add the above line to ``~/.profile`` so ``~/.local/bin`` is added to the path at login.

If you want to use the package with python 3 you might need to run pip3 in place of pip for above commands.


How to use
==========

Once you have correctly installed the package, you can run the simulation from any directory by typing into the command line::

    pumha <landscape_file> [<config_file>]

``<config_file>`` is a JSON type configuration file that contains all the information about the parameter values. You are welcome to play around with those values! You can find the default configuration file ``default.dat`` in  ``...installation_path/pumha/data`` directory (you can copy-paste it into your simulation directory, if you want).

If a configuration file is not provided, the program will display a warning and will continue, using the default values from ``default.dat`` file. If configuration file is not present or was accidentally deleted, it can be regenerated by running a simulation without specifying config file::
   
        pumha <landscape_file>

Therefore the simulation can be run without specifying a configuration file, but you must provide a ``<landscape_file>``. This file must be a bitmask ASCII file with the first row giving the dimensions of the landscape and rest of the rows representing landscape (1 for land square and 0 for water), as an example::

    5 7

    1 1 1 1 1 1 1
    1 1 1 1 0 0 1
    1 0 0 0 0 0 0
    1 1 0 0 0 1 1 
    1 1 0 0 0 1 1

There are some example landscapes in the ``...installation_path/pumha/data`` directory.


Once you have run the simulation, an output folder with a time stamp ``PumHa_out_Y-m-d-H-M-S`` will be created in your simulation directory. In that directory there will be a file ``average_densities.dat`` in which there are three columns, the first column giving a timestep value and rest two showing the average values of hare and puma densities on the whole landscape respectively. The average values are calculated for the whole landscape, including the water squares.

The rest of the files in the output folder are ppm image files that describe the densities of pumas and hares on a given timestep. Each pixel represents a square on landscape grid. Blue pixels denote water. On the pixels representing land, red denotes puma density and green hare density (so the more red/green the square, the higher is puma/hare population on that square). The population values are scaled relative to the highest density of animals that appeared in the whole simulation on a single square.  


How to  run tests
=================

To run the tests, go into the directory which contains ``setup.py`` and run the following command::

    python setup.py test

Depending on how you have installed the package, you might need to run the tests as root::

    sudo python setup.py test
  
Testing requires nose_ which will be installed by pip_ automatically together with other dependencies.


System compatibility and requirements
=====================================

The package was tested on::

    Scientific Linux release 7.3 (Nitrogen)
    Ubuntu 16.04.3 LTS
    Ubuntu 14.04 LTS
    Windows 10 Home
    
The package is likely to work on other systems as well, but this is not guaranteed. Also, if you are using an operating system which is not listed above, the installation procedure may differ from the one outlined in this document.

.. _numpy: https://pypi.python.org/pypi/numpy
.. _simplejson: https://pypi.python.org/pypi/simplejson/
.. _scipy: https://pypi.python.org/pypi/scipy
.. _tqdm: https://pypi.python.org/pypi/tqdm
.. _jsonschema: https://pypi.python.org/pypi/jsonschema
.. _docopt: https://pypi.python.org/pypi/docopt

The package requires following dependencies:

* `numpy`_ >=1.9.2
* `simplejson`_>=3.8.1
* `scipy`_>=0.15.1
* `tqdm`_>=4.19.4
* `jsonschema`_>=2.6.0
* `docopt`_>=0.6.2

The package has been tested with the minimum required version, but it is likely that the package will work with older versions as well. 

Above packages should be installed automatically when using pip_ (as described in the section `How to install`_). However, if there are some issues with the installation, they can be installed separately using pip_::
    
    sudo pip install  package_name
    
or if root is not available::

    pip install --user package_name
    
    
Key design decisions
====================

This section discusses some design and implementation decisions.

Usage properties
----------------

PumHa package has been designed keeping the ease of usage in mind. All the additional packages required for the code to run can easily installed with `pip`_ (see `How to install`_). Since it can be installed as a Python module, it can be easily used as a part of other simulation softwares.

Every simulation produces an output folder with a timestamp in its name, making it easy to keep track of previously run simulations. 


Handling input
--------------

The package has nice buit-in mechanisms for handling invalid input data:

* If a configuration file is not in a JSON format or has invalid input values, the program terminates the simulation and generates a new configuration file in a correct format, giving the user an opportunity to "try again" by changing parameter values in a correct configuration file.

* Classes Landscape and Configuration that deal with user input, have built-in error checks, that can handle majority of cases.

* If the user does not have a configuration file or has deleted the default one, it is simple to generate a new one - simply run the program without specifying a configuration file!

* The program will display an error message and terminate if no landscape file is provided, or if the landscape file is not in a correct format, since there is no point in running a simulation on a landscape that is not the one user wanted to simulate.


Class structure
---------------

The code is modular and loosely coupled and it is hence easy to extend it and make changes locally, without having to rewrite methods in different modules or classes. With the choice of variable names, the code aims to be as self-documenting as possible.

The modular structure and use of inheritance in the pumha.pop module allows modules and classes to be used in different projects. The population class has methods relevant to all populations, a user can create their own subclass with corresponding methods (that perhaps use different mathematical formalism). Setting up a simulation is very simple, requiring only at the least a landscape file and one population to be specified. Hence it is simple to create custom tailored simulations. 

Though it is possible to extend the code to include several populations, the output functions are specific to the case of two populations. There is a function that checks the number of populations in the simulation and if it is other than two, it displays a message and continues the simulation without providing output. 

To make the simulation faster, the methods responsible for the density updates only loop over land squares. For standard landscapes this implementation can reduce the total simulation time significantly. 



Output and visualisation
------------------------

The output file that lists average densities at given timesteps has the timestep value, hare density and puma density written as three columns respectively, making it simple to plot. 

In out visualisation implementation, both puma and hare densities on a given time step are shown on one PPM file, one pixel corresponding to one square on a grid, blue without any red or green representing water, green hare density and red puma density (for more information about the output, see `How to use`_). The RGB values representing the puma and hare densities are equal to the actual value of the density at the square. The colours are scaled using the maximum value of the density found during the simulation.

Since a line in a plain PPM file must be no longer than 70 characters, all the RGB values are written into an array of strings, each element in an array corresponging to a pixel. Those strings are then written on a file, four pixels per line (since that is the maximum amount of pixels that could fit to one line if both puma and hare densities are 5-digit numbers).
